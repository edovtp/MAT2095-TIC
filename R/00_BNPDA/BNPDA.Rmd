---
title: "Bayesian Nonparametric Data Analysis"
output:
  rmdformats::downcute:
    self_contained: true
    default_style: "light"
    downcute_theme: "default"
---

<style type="text/css">
.Wrap {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
library(tidyverse)
library(here)


## Global options
knitr::opts_chunk$set(cache = TRUE, fig.align = 'center', out.width = '90%')
here::i_am("R/00_BNPDA/BNPDA.Rmd")
set.seed(2211)

## Extra functions
source(here::here('R', 'code', '01_dirichlet_process.R'))
```

This notebook contains some replications of the results presented in the book *Bayesian Nonparametric Data Analysis*. This includes the implementation of general functions, which are saved in the folder `R/code/` for use in other scripts.

# 1. Dirichlet process

## 1.1. Stick-breaking construction

The **Stick-breaking construction** of a Dirichlet Process was given by Sethuraman (1994), which is based on the discrete nature of the process $G(\cdot)$. Formally, let $w_h = \upsilon_h \prod_{l<j}(1 - \upsilon_l)$ with $\upsilon_h \overset{i.i.d.}{\sim} \text{Beta}(1, M)$ and $m_h \overset{i.i.d.}{\sim}G_0$, then
$$
G(\cdot) = \sum_{h=1}^\infty w_h\delta_{m_h}(\cdot)
$$

defines a $\text{DP}(M G_0)$. Of course, we can only construct $G$ from a finite number of points, so I use a tolerance parameter which gives us a truncated distribution.

The function that implements the stick-breaking construction is in `R/code/01_dirichlet_process.R` with the name `tic_rdp()`.

### Examples - Normal distribution

In the following figures we show a random sample of size 15 from a DP process with the values of $M = 1, 20, 500$. We show this random sample via the ecdf, where we can see that effectively $E(G(B)) = G_0(B)$ and that the variance of $G(\cdot)$ decreases as $M$ increases.

```{r stick break - normal example, echo=FALSE, fig.align='center'}
dp_cdf <- function(results){
  dp_cdf_plot <- stepfun(results$locations, c(0, cumsum(results$probs)))
  plot(dp_cdf_plot, add = TRUE, col = 'red', lwd = 1.5, do.points = FALSE)
}

par(mfrow = c(1, 3))
### M = 1
dp_samples_1 <- replicate(15, tic_rdp(1, 'rnorm', list(mean = 0, sd = 1)))
curve(pnorm, lwd = 1.5, xlim = c(-3, 3), main = 'DP simulation - Normal with M = 1',
      ylab = 'F(x)')
invisible(apply(dp_samples_1, 2, dp_cdf))

### M = 20
dp_samples_20 <- replicate(15, tic_rdp(20, 'rnorm', list(mean = 0, sd = 1)))
curve(pnorm, lwd = 1.5, xlim = c(-3, 3), main = 'DP simulation - Normal with M = 20',
      ylab = 'F(x)')
invisible(apply(dp_samples_20, 2, dp_cdf))

### M = 500
dp_samples_500 <- replicate(15, tic_rdp(500, 'rnorm', list(mean = 0, sd = 1)))
curve(pnorm, lwd = 1.5, xlim = c(-3, 3), main = 'DP simulation - Normal with M = 500',
      ylab = 'F(x)')
invisible(apply(dp_samples_500, 2, dp_cdf))
```

### Examples - Poisson distribution

Using a Poisson centering measure we see the same results. It's important to know that if we use a discrete centering measure then the probability model for the number of different components change.

```{r stick break - poisson example, echo=FALSE}
par(mfrow = c(1, 3))
### M = 1
dp_samples_1 <- replicate(15, tic_rdp(1, 'rpois', list(lambda = 5)))
plot(stepfun(0:11, c(0, ppois(0:11, lambda = 5))), do.points = FALSE, lwd = 2,
     main = '', ylab = 'F(x)')
invisible(apply(dp_samples_1, 2, dp_cdf))

### M = 20
dp_samples_20 <- replicate(15, tic_rdp(20, 'rpois', list(lambda = 5)))
plot(stepfun(0:11, c(0, ppois(0:11, lambda = 5))), do.points = FALSE, lwd = 2,
     main = '', ylab = 'F(x)')
invisible(apply(dp_samples_20, 2, dp_cdf))

### M = 500
dp_samples_500 <- replicate(15, tic_rdp(500, 'rpois', list(lambda = 5)))
plot(stepfun(0:11, c(0, ppois(0:11, lambda = 5))), do.points = FALSE, lwd = 2,
     main = '', ylab = 'F(x)')
invisible(apply(dp_samples_500, 2, dp_cdf))
```

### Examples - Gamma distribution

Finally, we repeat the preceding using a Gamma centering measure.

```{r stick break - gamma example, echo=FALSE}
par(mfrow = c(1, 3))
### M = 1
dp_samples_1 <- replicate(15, tic_rdp(1, 'rgamma', list(shape = 6, rate = 4)))
curve(pgamma(x, shape = 6, rate = 4), lwd = 1.5, xlim = c(0, 4),
      main = 'DP simulation - Gamma with M = 1', ylab = 'F(x)')
invisible(apply(dp_samples_1, 2, dp_cdf))

### M = 20
dp_samples_20 <- replicate(15, tic_rdp(20, 'rgamma', list(shape = 6, rate = 4)))
curve(pgamma(x, shape = 6, rate = 4), lwd = 1.5, xlim = c(0, 4),
      main = 'DP simulation - Gamma with M = 20', ylab = 'F(x)')
invisible(apply(dp_samples_20, 2, dp_cdf))

### M = 500
dp_samples_500 <- replicate(15, tic_rdp(500, 'rgamma', list(shape = 6, rate = 4)))
curve(pgamma(x, shape = 6, rate = 4), lwd = 1.5, xlim = c(0, 4),
      main = 'DP simulation - Gamma with M = 500', ylab = 'F(x)')
invisible(apply(dp_samples_500, 2, dp_cdf))
```

## 1.2. Posterior distribution

## 1.3. Marginal distribution

Now, in order to simulate data from a DP we can proceed in two ways. In the first one we can simulate a DP process and then simulate data from that discrete distribution just sampled. 

The other way is to use the Polya urn representation of Blackwell and MacQueen (1973) of the marginal distribution, where,

$$
p(y_i | y_1, ..., y_{i-1}) = \frac{1}{M + i - 1} \sum_{h=1}^{i-1} \delta_{y_h}(y_i) + \frac{M}{M + i - 1}G_0(y_i)
$$

This can be written more compactly by

$$
p(y_i | y_1, ..., y_{i-1}) = \frac{M}{M + i - 1}G_0(y_i) + \frac{1}{M + i - 1}\sum_{j=1}^k n_j \delta_{y_j^*}(y_i)
$$

where $n_j$ is the number of occurrences of $y_j^*$.

The function that implements this sampling procedure `R/code/01_dirichlet_process.R` with the name `tic_rdp_data()`.

### Examples - Normal centering distribution

We use the implemented function to simulate a random sample of size 500, with different values of $M$. We can compare to the centering measure $G_0$ and note that as $M \to \infty$ we get a random sample that resembles more and more this distribution.

```{r dp marginal - normal example, echo=FALSE, fig.align='center'}
## Replicate simulations
sim_data_1_n <- tic_rdp_data(500, 1, 'rnorm', list(mean = 0, sd = 1))
sim_data_2_n <- tic_rdp_data(500, 10, 'rnorm', list(mean = 0, sd = 1))
sim_data_3_n <- tic_rdp_data(500, 50, 'rnorm', list(mean = 0, sd = 1))
sim_data_4_n <- tic_rdp_data(500, 100, 'rnorm', list(mean = 0, sd = 1))
sim_data_5_n <- tic_rdp_data(500, 1000, 'rnorm', list(mean = 0, sd = 1))
sim_data_6_n <- tic_rdp_data(500, 10000, 'rnorm', list(mean = 0, sd = 1))

par(mfrow = c(2, 3))
plot(density(sim_data_1_n), xlim = c(-3, 3), col = 'red', lwd = 2,
     main = 'M = 1')
curve(dnorm, add = TRUE, lwd = 2)

plot(density(sim_data_2_n), xlim = c(-3, 3), col = 'red', lwd = 2,
     main = 'M = 10')
curve(dnorm, add = TRUE, lwd = 2)

plot(density(sim_data_3_n), xlim = c(-3, 3), col = 'red', lwd = 2,
     main = 'M = 50')
curve(dnorm, add = TRUE, lwd = 2)

plot(density(sim_data_4_n), xlim = c(-3, 3), col = 'red', lwd = 2,
     main = 'M = 100')
curve(dnorm, add = TRUE, lwd = 2)

plot(density(sim_data_5_n), xlim = c(-3, 3), col = 'red', lwd = 2,
     main = 'M = 1000')
curve(dnorm, add = TRUE, lwd = 2)

plot(density(sim_data_6_n), xlim = c(-3, 3), col = 'red', lwd = 2,
     main = 'M = 10000')
curve(dnorm, add = TRUE, lwd = 2)
```

### Examples - Gamma centering distribution

```{r dp marginal - gamma example, echo=FALSE, fig.align='center'}
sim_data_1_n <- tic_rdp_data(500, 1, 'rgamma', list(shape = 3, rate = 10))
sim_data_2_n <- tic_rdp_data(500, 10, 'rgamma', list(shape = 3, rate = 10))
sim_data_3_n <- tic_rdp_data(500, 50, 'rgamma', list(shape = 3, rate = 10))
sim_data_4_n <- tic_rdp_data(500, 100, 'rgamma', list(shape = 3, rate = 10))
sim_data_5_n <- tic_rdp_data(500, 1000, 'rgamma', list(shape = 3, rate = 10))
sim_data_6_n <- tic_rdp_data(500, 10000, 'rgamma', list(shape = 3, rate = 10))

par(mfrow = c(2, 3))
plot(density(sim_data_1_n), xlim = c(0, 1), col = 'red', lwd = 2,
     main = 'M = 1')
curve(dgamma(x, shape = 3, rate = 10), add = TRUE, lwd = 2)

plot(density(sim_data_2_n), xlim = c(0, 1), col = 'red', lwd = 2,
     main = 'M = 10',
     ylim = c(0, 2.8))
curve(dgamma(x, shape = 3, rate = 10), add = TRUE, lwd = 2)

plot(density(sim_data_3_n), xlim = c(0, 1), col = 'red', lwd = 2,
     main = 'M = 50',
     ylim = c(0, 2.8))
curve(dgamma(x, shape = 3, rate = 10), add = TRUE, lwd = 2)

plot(density(sim_data_4_n), xlim = c(0, 1), col = 'red', lwd = 2,
     main = 'M = 100',
     ylim = c(0, 2.8))
curve(dgamma(x, shape = 3, rate = 10), add = TRUE, lwd = 2)

plot(density(sim_data_5_n), xlim = c(0, 1), col = 'red', lwd = 2,
     main = 'M = 1000',
     ylim = c(0, 2.8))
curve(dgamma(x, shape = 3, rate = 10), add = TRUE, lwd = 2)

plot(density(sim_data_6_n), xlim = c(0, 1), col = 'red', lwd = 2,
     main = 'M = 10000',
     ylim = c(0, 2.8))
curve(dgamma(x, shape = 3, rate = 10), add = TRUE, lwd = 2)
```
